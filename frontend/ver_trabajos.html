<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercado de Trabajos - Servicios del Hogar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="principal.css">
    <style>
        body { background-color: #f4f6f8; align-items: flex-start; }
        
        /* Header Sticky */
        header {
            background: white; padding: 15px 5%; display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); width: 100%;
            position: sticky; top: 0; z-index: 100;
        }

        .container-market { max-width: 900px; margin: 40px auto; padding: 0 20px; width: 100%; }

        .market-header { text-align: center; margin-bottom: 40px; }
        .market-header h1 { color: #333; font-size: 28px; margin-bottom: 10px; }
        .market-header p { color: #666; }

        /* Tarjeta de Trabajo (Job Card) */
        .job-card {
            background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee;
            transition: transform 0.2s, box-shadow 0.2s; position: relative;
        }
        .job-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

        /* Cabecera de la Tarjeta */
        .job-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        
        .job-cat { 
            background: #e6f0ff; color: #0b69ff; padding: 6px 12px; 
            border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; 
            display: inline-flex; align-items: center; gap: 5px;
        }
        
        .job-budget { 
            font-size: 18px; font-weight: 800; color: #28a745; 
            background: #e8f5e9; padding: 5px 10px; border-radius: 8px;
        }

        .job-title { font-size: 20px; font-weight: bold; color: #222; margin: 10px 0 5px; }
        .job-client { font-size: 13px; color: #777; display: flex; align-items: center; gap: 5px; }
        
        .job-desc { 
            font-size: 15px; color: #555; line-height: 1.5; margin: 15px 0; 
            background: #f9f9f9; padding: 15px; border-radius: 8px; border-left: 4px solid #0b69ff;
        }

        /* Datos Extra (Fecha, Lugar) */
        .job-meta { 
            display: flex; gap: 20px; flex-wrap: wrap; font-size: 13px; color: #666; 
            padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;
        }
        .meta-item { display: flex; align-items: center; gap: 8px; }
        .meta-item i { color: #aaa; }

        /* Foto de Evidencia */
        .job-photo {
            width: 100%; height: 200px; object-fit: cover; border-radius: 8px;
            margin-top: 15px; cursor: pointer; transition: 0.2s;
        }
        .job-photo:hover { opacity: 0.9; }

        /* Botón Postularse */
        .btn-postular {
            background-color: #0b69ff; color: white; border: none; padding: 12px 25px;
            border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 15px;
            transition: 0.2s; width: 100%; margin-top: 20px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-postular:hover { background-color: #0056d6; box-shadow: 0 5px 15px rgba(11,105,255,0.3); }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px; color: #999; }
        .empty-icon { font-size: 60px; margin-bottom: 20px; color: #eee; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <div class="logo" style="font-weight: bold; color: #0b69ff; font-size: 22px; cursor:pointer;" onclick="window.location.href='dashboard.html'">
            <i class="fas fa-home"></i> Homely
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="user-name" style="color: #555; font-weight: 500;">Colega</span>
            <button onclick="window.location.href='dashboard.html'" style="padding: 6px 15px; border: 1px solid #ddd; background: white; border-radius: 20px; cursor: pointer; font-weight:bold; color:#555;">
                <i class="fas fa-arrow-left"></i> Volver al Panel
            </button>
        </div>
    </header>

    <div class="container-market">
        <div class="market-header">
            <h1><i class="fas fa-briefcase" style="color:#0b69ff;"></i> Trabajos Disponibles</h1>
            <p>Revisa las solicitudes cercanas y envía tu mejor oferta.</p>
        </div>

        <!-- AQUÍ SE CARGAN LAS TARJETAS -->
        <div id="lista-trabajos">
            <p style="text-align:center; color:#999;">Buscando oportunidades...</p>
        </div>
    </div>

    <script>
        const usuarioId = localStorage.getItem("usuario_id");
        const usuarioNombre = localStorage.getItem("usuario_nombre");
        const esTrabajador = localStorage.getItem("es_trabajador") === "true";

        // 1. PROTECCIÓN: Solo trabajadores pueden ver esto
        if (!usuarioId) window.location.href = "login.html";
        if (!esTrabajador) {
            alert("Solo los trabajadores pueden ver esta sección.");
            window.location.href = "dashboard.html";
        }

        document.getElementById('user-name').innerText = usuarioNombre ? usuarioNombre.split(" ")[0] : "Colega";

        // 2. CARGAR FEED
        async function cargarFeed() {
            const contenedor = document.getElementById('lista-trabajos');
            
            try {
                const res = await fetch("http://localhost:8080/feed-servicios");
                
                if(!res.ok) throw new Error("Error al conectar con servidor");
                
                const trabajos = await res.json();
                contenedor.innerHTML = "";

                if(trabajos.length === 0) {
                    contenedor.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-mug-hot empty-icon"></i>
                            <h3>Todo tranquilo por ahora</h3>
                            <p>No hay solicitudes nuevas en este momento. Vuelve más tarde.</p>
                        </div>
                    `;
                    return;
                }

                trabajos.forEach(t => {
                    // Formatear fecha
                    const fechaObj = new Date(t.fecha_programada);
                    const fechaStr = fechaObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' });
                    
                    // Precio
                    const precio = t.precio_estimado > 0 ? `$${t.precio_estimado}` : "A convenir";
                    
                    // Foto (Si existe)
                    const fotoHTML = t.foto_evidencia_url 
                        ? `<img src="${t.foto_evidencia_url}" class="job-photo" onclick="window.open(this.src, '_blank')">` 
                        : "";

                    const html = `
                        <div class="job-card">
                            <div class="job-top">
                                <div class="job-cat"><i class="fas fa-tag"></i> ${t.categoria}</div>
                                <div class="job-budget">${precio}</div>
                            </div>
                            
                            <h3 class="job-title">${t.titulo}</h3>
                            <div class="job-client"><i class="fas fa-user-circle"></i> Cliente: ${t.cliente_nombre}</div>
                            
                            <div class="job-desc">
                                "${t.descripcion}"
                            </div>
                            
                            ${fotoHTML}

                            <div class="job-meta">
                                <div class="meta-item"><i class="far fa-calendar-alt"></i> ${fechaStr}</div>
                                <div class="meta-item"><i class="fas fa-map-marker-alt"></i> ${t.direccion_texto || 'Ubicación en mapa'}</div>
                            </div>

                            <button onclick="postularse('${t.id}', '${t.titulo}')" class="btn-postular">
                                <i class="fas fa-hand-paper"></i> Enviar Propuesta
                            </button>
                        </div>
                    `;
                    contenedor.innerHTML += html;
                });

            } catch(e) {
                console.error(e);
                contenedor.innerHTML = "<p style='text-align:center; color:red;'>No pudimos cargar los trabajos. Revisa tu conexión.</p>";
            }
        }

        // 3. POSTULARSE (Enviar propuesta)
        async function postularse(servicioId, tituloTrabajo) {
            const { value: formValues } = await Swal.fire({
                title: 'Postularme al trabajo',
                html: `
                    <p style="font-size:14px; color:#666; margin-bottom:15px;">Estás aplicando para: <b>${tituloTrabajo}</b></p>
                    
                    <label style="display:block; text-align:left; font-weight:bold; margin-bottom:5px;">Tu Oferta ($):</label>
                    <input id="swal-precio" type="number" class="swal2-input" min="0" placeholder="Ej. 350" style="margin:0 0 15px 0;">
                    
                    <label style="display:block; text-align:left; font-weight:bold; margin-bottom:5px;">Mensaje al cliente:</label>
                    <textarea id="swal-msg" class="swal2-textarea" placeholder="Hola, puedo ir hoy mismo..." style="margin:0;"></textarea>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Enviar Propuesta',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const precio = document.getElementById('swal-precio').value;
                    const mensaje = document.getElementById('swal-msg').value;
                    if (!precio || !mensaje) {
                        Swal.showValidationMessage('Por favor escribe un precio y un mensaje');
                    }
                    return { precio: parseFloat(precio), mensaje: mensaje };
                }
            });

            if (formValues) {
                // Enviar al Backend
                try {
                    const datos = {
                        servicio_id: servicioId,
                        trabajador_id: usuarioId,
                        precio_oferta: formValues.precio,
                        mensaje: formValues.mensaje
                    };

                    const res = await fetch("http://localhost:8080/propuestas", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(datos)
                    });

                    const result = await res.json();

                    if (res.ok) {
                        Swal.fire("¡Enviado!", "Tu propuesta ha sido enviada al cliente.", "success");
                        // Opcional: Recargar para quitar el trabajo de la lista o marcarlo
                    } else {
                        Swal.fire("Error", result.detail || "No se pudo enviar.", "error");
                    }

                } catch (e) {
                    Swal.fire("Error", "Error de conexión", "error");
                }
            }
        }

        // INICIAR
        cargarFeed();
    </script>

</body>
</html>